name: E2E Tests

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    name: E2E Tests
    runs-on: ubuntu-latest
    environment: CI
    env:
      ETHEREUM_JSON_RPC_API_URL: ${{ secrets.ETHEREUM_JSON_RPC_API_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v3
        with:
          node-version: "20.x"

      - name: Enable Corepack and Install Yarn 4
        run: |
          corepack enable
          yarn set version latest

      - name: Install Dependencies
        run: yarn install

      - name: Install Nargo
        uses: noir-lang/noirup@v0.1.4
        with:
          toolchain: 1.0.0-beta.18

      - name: Compile Circuit
        run: nargo compile --workspace --skip-brillig-constraints-check

      - name: Start Oracle Server
        working-directory: ethereum/oracles
        run: |
          yarn oracle-server &
          ORACLE_SERVER_PID=$!
          echo "ORACLE_SERVER_PID=$ORACLE_SERVER_PID" >> $GITHUB_ENV

      - name: Install Barretenberg
        run: |
          curl -L https://raw.githubusercontent.com/AztecProtocol/aztec-packages/refs/heads/next/barretenberg/bbup/install | bash
          ~/.bb/bbup -nv 1.0.0-beta.18
          sudo apt install libc++-dev

      - name: Generate Witnesses
        run: |
          nargo execute --package get_header --oracle-resolver=http://localhost:5555 --skip-brillig-constraints-check
          nargo execute --package get_account --oracle-resolver=http://localhost:5555 --skip-brillig-constraints-check
          nargo execute --package get_storage --oracle-resolver=http://localhost:5555 --skip-brillig-constraints-check
          nargo execute --package get_receipt --oracle-resolver=http://localhost:5555 --skip-brillig-constraints-check
          nargo execute --package get_transaction --oracle-resolver=http://localhost:5555 --skip-brillig-constraints-check
          nargo execute --package get_log --oracle-resolver=http://localhost:5555 --skip-brillig-constraints-check

      - name: Debug - List Generated Files
        run: |
          echo "=== Checking target directories ==="
          find . -name "*.json" -path "*/target/*" -type f
          echo "=== Checking for .gz files ==="
          find . -name "*.gz" -path "*/target/*" -type f
          echo "=== Directory structure of ethereum/circuits/get_header/target ==="
          ls -la ethereum/circuits/get_header/target/ || echo "Directory not found"

      - name: Generate Proofs
        run: |
          export PATH="$HOME/.bb:$PATH"
          bb prove -b ./ethereum/circuits/get_header/target/get_header.json -w ./ethereum/circuits/get_header/target/get_header.gz -o ./ethereum/circuits/get_header/target/proof
          bb prove -b ./ethereum/circuits/get_account/target/get_account.json -w ./ethereum/circuits/get_account/target/get_account.gz -o ./ethereum/circuits/get_account/target/proof
          bb prove -b ./ethereum/circuits/get_storage/target/get_storage.json -w ./ethereum/circuits/get_storage/target/get_storage.gz -o ./ethereum/circuits/get_storage/target/proof
          bb prove -b ./ethereum/circuits/get_receipt/target/get_receipt.json -w ./ethereum/circuits/get_receipt/target/get_receipt.gz -o ./ethereum/circuits/get_receipt/target/proof
          bb prove -b ./ethereum/circuits/get_transaction/target/get_transaction.json -w ./ethereum/circuits/get_transaction/target/get_transaction.gz -o ./ethereum/circuits/get_transaction/target/proof
          bb prove -b ./ethereum/circuits/get_log/target/get_log.json -w ./ethereum/circuits/get_log/target/get_log.gz -o ./ethereum/circuits/get_log/target/proof

      # Note: Solidity verifier generation is not yet supported for UltraHonk in Nargo 1.0+
      # Using pre-generated verifier contracts committed to the repository
      # TODO: Re-enable when bb write_solidity_verifier supports Honk
      # - name: Generate Verifier Contracts
      #   run: |
      #     bb write_solidity_verifier -k ./target/get_header/vk/vk -o ./contract/get_header/plonk_vk.sol
      #     bb write_solidity_verifier -k ./target/get_account/vk/vk -o ./contract/get_account/plonk_vk.sol
      #     bb write_solidity_verifier -k ./target/get_storage/vk/vk -o ./contract/get_storage/plonk_vk.sol
      #     bb write_solidity_verifier -k ./target/get_receipt/vk/vk -o ./contract/get_receipt/plonk_vk.sol
      #     bb write_solidity_verifier -k ./target/get_transaction/vk/vk -o ./contract/get_transaction/plonk_vk.sol
      #     bb write_solidity_verifier -k ./target/get_log/vk/vk -o ./contract/get_log/plonk_vk.sol

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Compile Smart Contract
        working-directory: ethereum/contracts
        run: forge build

      - name: Run TypeScript Build
        run: yarn build

      - name: Run Unit Tests
        working-directory: ethereum/oracles
        run: yarn test:unit

      - name: Run e2e Tests
        working-directory: ethereum/tests
        run: yarn test:e2e

      - name: Stop Oracle Server
        if: always()
        run: kill $ORACLE_SERVER_PID
